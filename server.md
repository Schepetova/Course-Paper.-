<h1> API-сервер. Серверная часть.

<h2> Содержание
<h4>

* что такое API-сервер?
* Среда разработки
* Роутеры, контроллеры, модели
* Промежуточные обработчики запросов
* Вспомогательные программы
* Серверные части методов. Техническое задание.
* Список источников
---



<h4> 
API – это механизмы, которые позволяют двум программным компонентам взаимодействовать друг с другом, используя набор определений и протоколов. Например, система ПО метеослужбы содержит ежедневные данные о погоде. Приложение погоды на телефоне «общается» с этой системой через API и показывает ежедневные обновления погоды на телефоне.

<h2>
Что значит API?
<h4>API – Application Programming Interface, что значит программный интерфейс приложения. В контексте API слово «приложение» относится к любому ПО с определенной функцией. Интерфейс можно рассматривать как сервисный контракт между двумя приложениями. Этот контракт определяет, как они взаимодействуют друг с другом, используя запросы и ответы. Документация API содержит информацию о том, как разработчики должны структурировать эти запросы и ответы.

<h2>Как работают API?

<h4>Архитектура API обычно объясняется с точки зрения клиента и сервера. Приложение, отправляющее запрос, называется клиентом, а приложение, отправляющее ответ, называется сервером. Итак, в примере с погодой база данных службы – это сервер, а мобильное приложение – это клиент. 

---

Структура API–сервера предполагает деление логики серверного приложения на своеобразные прослойки, через которые проходят данные пришедшие с клиентской части. Список логических прослоек:
* роутеры; 
* контроллеры; 
* сервисы; 
* промежуточные обработчики запросов «MiddleWare»; 
* модели.

![Api](https://sun1.userapi.com/sun1-21/s/v1/ig2/XmhYBQTA_TEh_BTmotsyDRKdauIhc4BHXt1hnZUo8J3nKnoebgYKDRiU6Z_mZjEqJLFW36h4D3YnAYW0-ypF4oz8.jpg?size=974x417&quality=96&type=album)

---
<h2> Cреда разработки

Язык JavaScript 

<h4>
Современный JavaScript – это «безопасный» динамический язык программирования. Он не предоставляет низкоуровневый доступ к памяти или процессору, потому что изначально был создан для браузеров, не требующих этого. Возможности JavaScript сильно зависят от окружения, в котором он работает. Например, Node.JS поддерживает функции чтения/записи произвольных файлов, выполнения сетевых запросов и т.д. Сегодня JavaScript может выполняться не только в браузере, но и на сервере или на любом другом устройстве, которое имеет специальную программу, называющуюся движком JavaScript.

<h2>
Программная платформа Node.js
<h4>
Node – это кроссплатформенная среда исполнения с открытым исходным кодом, которая позволяет разработчикам создавать всевозможные серверные инструменты и приложения используя язык JavaScript. Среда исполнения предназначена для использования вне контекста браузера, то есть выполнение происходит непосредственно на компьютере или на серверной операционной системе. Таким образом, Node исключает API – интерфейсы JavaScript для браузера и добавляет поддержку более традиционных API – интерфейсов операционной системы, включая библиотеки HTTP и файловых систем. Далее будут рассмотрены основные особенности программной платформы Node.

<h2>Vue.js
<h4>
Vue.js - JavaScript-фреймворк с открытым исходным кодом для создания пользовательских интерфейсов. Легко интегрируется в проекты с использованием других JavaScript-библиотек. Может функционировать как веб-фреймворк для разработки одностраничных приложений в реактивном стиле.
Для работы c Vue.js требуется установить также Vue CLI - представляет собой набор инструментов для быстрого  прототипирования, легкого создания новых приложений и эффективного управления проектами на Vue.js.

---
Работа будет сделана в текстовом редакторе Visual Studio Code, так как он имеет встроенную поддержку Vue.js, построение блоков HTML, CSS и JavaScript

___
<h2> Роутеры, контроллеры, модели
<h4> 

* Если говорить простым языком, роутеры агрегируют запросы.Они предназначены для агрегации запросов и их валидации со стороны клиента и передачи данных в контроллеры веб-системы.

* Контроллеры являются начальным слоем бизнес логики веб-системы. На данном уровне происходит непосредственная обработка запросов со стороны клиента. Контроллеры достают из параметров и тела запроса необходимые данные и передают их на уровень сервисов, после получения ответа от сервиса, контроллеры отправляют ответ на сторону клиента. То есть они готовят данные для сервисов. 

* Сервисы подключаются к моделям и работают с базой данных.

*  Моделью удаленного доступа к данным (RDA) реализуются функции представления информации и логика прикладной обработки с помощью совмещенных программ, которые выполняются на клиенте.
В модели сервера БД (DBS) функции клиента ограничены функциями представления информации, а прикладные функции обеспечивает приложение, которое находится на сервере. Такая модель более технологична, чем модель RDA, и реализуется в СУБД Oracle, Sybase и Ingress. Приложения при этом реализуются как хранимые процедуры.
Модель распределенного представления представлена мощным сервером, а клиенты практически отсутствуют. К функциям клиента относится простое отображение информации на мониторе и связь с сервером с помощью локальной сети.



---

<h2> Промежуточные обработчики запросов


<h4> 
Обработчиком называется то, что принимает запрос и возвращает ответ. В процессе работы с сервером часто возникают ошибки, и их нужно как-то обрабатывать. Для этого нам нужно создать промежуточный обработчик запросов (представлен выше на схеме), который принимает на себя самые первые данные. Для этого мы создаем папки handler и middleware. Промежуточная обработка (middleware) представляет собой обёртывание одного HTTP-обработчика другим. Это позволяет реализовать аутентификацию, журналирование, сжатие и другую функциональность.
Здесь будет происходить обработка ошибок.

ErrorMiddleware -  Данный обработчик предназначен для отправки статус кодов на сторону клиента. Здесь находится функция, которая проверяет, есть ли ошибка в apistatus, если она там есть, то мы возвращаем статус и сообщение, если же этой ошибки там нет, мы возвращаем статус 500 и непредвиденную ошибку. 

---
<h2> Вспомогательные программы
<h4>
PostgreSQL. Также для работы с базой данных и сервером нам понадобятся PostgreSQL -  мощная объектно-реляционная система баз данных с открытым исходным кодом и Postman - это платформа API для разработчиков, позволяющая разрабатывать, создавать, тестировать и повторять свои API.  

Фундаментальная характеристика объектно-реляционной базы данных — это поддержка пользовательских объектов и их поведения, включая типы данных, функции, операции, домены и индексы. Это делает PostgreSQL невероятно гибким и надежным. Среди прочего, он умеет создавать, хранить и извлекать сложные структуры данных. В некоторых примерах ниже вы увидите вложенные и составные конструкции, которые не поддерживаются стандартными РСУБД. Существует обширный список типов данных, которые поддерживает PostgreSQL. Кроме числовых, с плавающей точкой, текстовых, булевых и других ожидаемых типов данных (а также множества их вариаций), PostgreSQL может похвастаться поддержкой uuid, денежного, перечисляемого, геометрического, бинарного типов, сетевых адресов, битовых строк, текстового поиска, xml, json, массивов, композитных типов и диапазонов, а также некоторых внутренних типов для идентификации объектов и местоположения логов. Справедливости ради стоит сказать, что MySQL, MariaDB и Firebird тоже имеют некоторые из этих типов данных, но только PostgreSQL поддерживает их все.
PostgreSQL обеспечивает хранение разных типов сетевых адресов. Тип данных CIDR (бесклассовая маршрутизация интернет домена, Classless Internet Domain Routing) следует соглашению для сетевых адресов IPv4 и IPv6.
Поскольку Постгрес — это объектно-реляционная база данных, массивы значений могут храниться для большинства существующих типов данных.

Postman. Основное предназначение Postman'a — создание коллекций с запросами к вашему API. Любой разработчик или тестировщик, открыв коллекцию, сможет с лёгкостью разобраться в работе вашего сервиса. Ко всему прочему, Postman позволяет проектировать дизайн API и создавать на его основе Mock-сервер. Вашим разработчикам больше нет необходимости тратить время на создание "заглушек". Реализацию сервера и клиента можно запустить одновременно. Тестировщики могут писать тесты и производить автоматизированное тестирование прямо из Postman. 
Чтобы проверить работоспособность нашего сервера, в теле postman'а в порфмате json вводим значения, подаваемые на вход. После этого нам должны выдать другие посчитанные значения. 
![Postgres](https://www.pvsm.ru/images/2018/06/14/po-sledam-meetup-novye-vozmojnosti-PostgreSQL-11.png)
![Postman](https://meshworld.in/blog/how-to/install-postman-native-app-in-ubuntu/featured.png)


![Postman](https://sun9-north.userapi.com/sun9-83/s/v1/ig2/-cPyQPVQcVRTy5U7jfbcurPQarvDkp54Xi3A3gFgu5T0g5duBk-5dSf8AbT2DND_9mWeh1Ru06tIE6XrC44D5dce.jpg?size=974x608&quality=96&type=album)
 
 <h4> Проверка нашего сервера на работоспособность в программе Postman 

---
<h2> Серверные части методов. Техническое задание

<h4> 
Калькулятор расчета гемодинамики. 
Гемодинамика - движение крови по сосудам, возникающее вследствие разности гидростатического давления в различных участках кровеносной системы. Есть поле для ввода параметров, в которое вручную вводятся значения. Если какой-либо пациент имеется в базе, то эти данные вводятся автоматически. 
Все параметры распределены на категории оценки функций гемодинамики, то есть всего у нас есть 4 метода - Вывод (Output), Постнагрузка (Postload), Преднагрузка (Preload), Сократимость (Contractility), в каждом из них есть свои параметры. В конце выводится сводный лист показателей.  В него включаются как введенные вручную или взятые из базы данные, так и расчетные величины.

---
Рассмотрим кратко работу сервера на примере одного из методов - Вывода(Output).
Для начала нам нужно связать две таблицы, чтобы по пользователю мы могли искать нужные нам параметры. 

```JavaScript
const Output = sequelize.define("Output", {
    id: {type:DataTypes.INTEGER, required:true, primaryKey:true, autoIncrement:true},
    SV: {type:DataTypes.REAL, required:true}, 
    SI: {type:DataTypes.REAL, required:true},
    UO: {type:DataTypes.REAL, required:true},
    IUO: {type:DataTypes.REAL, required:true},   
    CHSS: {type:DataTypes.REAL, required:true}
})
```
Некоторые параметры у нас задаются изначально - остальные считаются. Для этого нам нужно вызвать сервис, где мы считаем недостающие параметры. Для этого нам также нужно подсоединить роутер к контроллеру. (в нашем случае - к CalculationController).

```JavaScript
const OutputService = require("../services/outputService");
```

Также не забываем про проверку на наличие полей, это делаем в роутере. 
```JavaScript
    //! Проверка на наличие полей
    body('SV').exists(),
    body('CHSS').exists(),
    body('PPT').exists(),
    //! Вызов метода контроллера
    CalculationController.OutputCalc;

```
Если нет никаких ошибок, мы можем достать данные.
После этого мы вызываем сервис, в котором это все считаем. 

Для остальных методов все действия проводятся аналогично. 

---
<h2> Список источников
<h4>

1.  REST in Practice: Hypermedia and Systems ArchitectureREST in Practice: Hypermedia and Systems Architecture - Jim Webber,Savas Parastatidis, Ian Robinson · 2010 - 415c.

1. [Грамотная клиент-серверная архитектура: как правильно проектировать и разрабатывать web API](https://tproger.ru/articles/web-api/) 

1. [Использование промежуточных обработчиков express](https://expressjs.com/ru/guide/using-middleware.html)

1. [Введение в постман\Хабр](https://habr.com/ru/company/kolesa/blog/351250/)

1. [PostgreSQL](https://habr.com/ru/post/282764/)